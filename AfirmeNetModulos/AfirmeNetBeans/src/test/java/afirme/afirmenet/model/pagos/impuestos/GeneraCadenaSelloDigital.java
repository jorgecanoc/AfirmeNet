package afirme.afirmenet.model.pagos.impuestos;

import org.apache.commons.lang.StringUtils;
import org.junit.Test;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.afirme.afirmenet.model.pagos.impuestos.Concepto;
import com.afirme.afirmenet.model.pagos.impuestos.Conceptos;
import com.afirme.afirmenet.model.pagos.impuestos.Derechos;
import com.afirme.afirmenet.utils.xml.ParseXMLToPojoFactory;

public class GeneraCadenaSelloDigital {
	static final Logger LOG = LoggerFactory
			.getLogger(GeneraCadenaSelloDigital.class);	
	@Test
	public void generaCadenaSelloDigital(){
		StringBuilder cadenaFinal = new StringBuilder();
		String INICIO_FIN_CADENA ="||";
		String INICIO_FIN_CAMPO ="|";
		String xml="<?xml version=\"1.0\" ?><DERECHOS><IDENTIFICACION><CONCEPTO><CLAVE>10001</CLAVE><DESCRIPCION>RFC</DESCRIPCION><VALOR>CACJ811003H35</VALOR><VALORIMPRESION>CACJ811003H35</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>10002</CLAVE><DESCRIPCION>CURP</DESCRIPCION><VALOR>CACJ811003HDFNVR09</VALOR><VALORIMPRESION>CACJ811003HDFNVR09</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>10003</CLAVE><DESCRIPCION>Apellido paterno</DESCRIPCION><VALOR>CANO</VALOR><VALORIMPRESION>CANO</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>10004</CLAVE><DESCRIPCION>Apellido materno</DESCRIPCION><VALOR>CUEVAS</VALOR><VALORIMPRESION>CUEVAS</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>10005</CLAVE><DESCRIPCION>Nombre</DESCRIPCION><VALOR>JORGE ALBERTO</VALOR><VALORIMPRESION>JORGE ALBERTO</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>10017</CLAVE><DESCRIPCION>Total efectivamente pagado</DESCRIPCION><VALOR>2684</VALOR><VALORIMPRESION>&#x24;2,684.00</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>30005</CLAVE><DESCRIPCION>Dependencia</DESCRIPCION><VALOR>34</VALOR><VALORIMPRESION>34 Comisi&#xf3;n Nacional para el Uso Eficiente de la Energ&#xed;a</VALORIMPRESION></CONCEPTO></IDENTIFICACION><CONCEPTOS><CONCEPTO><CLAVE>14701</CLAVE><DESCRIPCION>Nombre del Concepto</DESCRIPCION><VALOR>Derechos, Productos y Aprovechamientos</VALOR><VALORIMPRESION>Derechos, Productos y Aprovechamientos</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>14702</CLAVE><DESCRIPCION>Per&#xed;odo</DESCRIPCION><VALOR>1</VALOR><VALORIMPRESION>Enero</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>14727</CLAVE><DESCRIPCION>Ejercicio</DESCRIPCION><VALOR>2005</VALOR><VALORIMPRESION>2005</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>14704</CLAVE><DESCRIPCION>Importe</DESCRIPCION><VALOR>1000</VALOR><VALORIMPRESION>&#x24;1,000.00</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>14705</CLAVE><DESCRIPCION>Parte Actualizada</DESCRIPCION><VALOR>50</VALOR><VALORIMPRESION>&#x24;50.00</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>14706</CLAVE><DESCRIPCION>Recargos</DESCRIPCION><VALOR>50</VALOR><VALORIMPRESION>&#x24;50.00</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>14707</CLAVE><DESCRIPCION>Multa por Correcci&#xf3;n</DESCRIPCION><VALOR>50</VALOR><VALORIMPRESION>&#x24;50.00</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>14708</CLAVE><DESCRIPCION>Total de Contribuciones</DESCRIPCION><VALOR>1150</VALOR><VALORIMPRESION>&#x24;1,150.00</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>14720</CLAVE><DESCRIPCION>Cantidad Pagada</DESCRIPCION><VALOR>1150</VALOR><VALORIMPRESION>&#x24;1,150.00</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>14733</CLAVE><DESCRIPCION>Clave de Referencia del DPA</DESCRIPCION><VALOR>346000601</VALOR><VALORIMPRESION>346000601</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>14734</CLAVE><DESCRIPCION>Cadena de la dependencia</DESCRIPCION><VALOR>CERTIF20051053</VALOR><VALORIMPRESION>CERTIF20051053</VALORIMPRESION></CONCEPTO></CONCEPTOS><CONCEPTOS><CONCEPTO><CLAVE>12001</CLAVE><DESCRIPCION>Nombre del Concepto</DESCRIPCION><VALOR>IVA actos accidentales</VALOR><VALORIMPRESION>IVA actos accidentales</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>12002</CLAVE><DESCRIPCION>Per&#xed;odo</DESCRIPCION><VALOR>7</VALOR><VALORIMPRESION>Julio</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>12027</CLAVE><DESCRIPCION>Ejercicio</DESCRIPCION><VALOR>2015</VALOR><VALORIMPRESION>2015</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>12004</CLAVE><DESCRIPCION>Importe</DESCRIPCION><VALOR>160</VALOR><VALORIMPRESION>&#x24;160.00</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>12005</CLAVE><DESCRIPCION>Parte Actualizada</DESCRIPCION><VALOR>8</VALOR><VALORIMPRESION>&#x24;8.00</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>12006</CLAVE><DESCRIPCION>Recargos</DESCRIPCION><VALOR>8</VALOR><VALORIMPRESION>&#x24;8.00</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>12007</CLAVE><DESCRIPCION>Multa por Correcci&#xf3;n</DESCRIPCION><VALOR>8</VALOR><VALORIMPRESION>&#x24;8.00</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>12008</CLAVE><DESCRIPCION>Total de Contribuciones</DESCRIPCION><VALOR>184</VALOR><VALORIMPRESION>&#x24;184.00</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>12020</CLAVE><DESCRIPCION>Cantidad Pagada</DESCRIPCION><VALOR>184</VALOR><VALORIMPRESION>&#x24;184.00</VALORIMPRESION></CONCEPTO></CONCEPTOS><CONCEPTOS><CONCEPTO><CLAVE>14701</CLAVE><DESCRIPCION>Nombre del Concepto</DESCRIPCION><VALOR>Derechos, Productos y Aprovechamientos</VALOR><VALORIMPRESION>Derechos, Productos y Aprovechamientos</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>14702</CLAVE><DESCRIPCION>Per&#xed;odo</DESCRIPCION><VALOR>2</VALOR><VALORIMPRESION>Febrero</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>14727</CLAVE><DESCRIPCION>Ejercicio</DESCRIPCION><VALOR>2005</VALOR><VALORIMPRESION>2005</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>14704</CLAVE><DESCRIPCION>Importe</DESCRIPCION><VALOR>1000</VALOR><VALORIMPRESION>&#x24;1,000.00</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>14705</CLAVE><DESCRIPCION>Parte Actualizada</DESCRIPCION><VALOR>50</VALOR><VALORIMPRESION>&#x24;50.00</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>14706</CLAVE><DESCRIPCION>Recargos</DESCRIPCION><VALOR>50</VALOR><VALORIMPRESION>&#x24;50.00</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>14707</CLAVE><DESCRIPCION>Multa por Correcci&#xf3;n</DESCRIPCION><VALOR>50</VALOR><VALORIMPRESION>&#x24;50.00</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>14708</CLAVE><DESCRIPCION>Total de Contribuciones</DESCRIPCION><VALOR>1150</VALOR><VALORIMPRESION>&#x24;1,150.00</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>14720</CLAVE><DESCRIPCION>Cantidad Pagada</DESCRIPCION><VALOR>1150</VALOR><VALORIMPRESION>&#x24;1,150.00</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>14733</CLAVE><DESCRIPCION>Clave de Referencia del DPA</DESCRIPCION><VALOR>346000601</VALOR><VALORIMPRESION>346000601</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>14734</CLAVE><DESCRIPCION>Cadena de la dependencia</DESCRIPCION><VALOR>CERTIF20051043</VALOR><VALORIMPRESION>CERTIF20051043</VALORIMPRESION></CONCEPTO></CONCEPTOS><CONCEPTOS><CONCEPTO><CLAVE>12001</CLAVE><DESCRIPCION>Nombre del Concepto</DESCRIPCION><VALOR>IVA actos accidentales</VALOR><VALORIMPRESION>IVA actos accidentales</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>12002</CLAVE><DESCRIPCION>Per&#xed;odo</DESCRIPCION><VALOR>7</VALOR><VALORIMPRESION>Julio</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>12027</CLAVE><DESCRIPCION>Ejercicio</DESCRIPCION><VALOR>2015</VALOR><VALORIMPRESION>2015</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>12004</CLAVE><DESCRIPCION>Importe</DESCRIPCION><VALOR>170</VALOR><VALORIMPRESION>&#x24;170.00</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>12005</CLAVE><DESCRIPCION>Parte Actualizada</DESCRIPCION><VALOR>10</VALOR><VALORIMPRESION>&#x24;10.00</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>12006</CLAVE><DESCRIPCION>Recargos</DESCRIPCION><VALOR>10</VALOR><VALORIMPRESION>&#x24;10.00</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>12007</CLAVE><DESCRIPCION>Multa por Correcci&#xf3;n</DESCRIPCION><VALOR>10</VALOR><VALORIMPRESION>&#x24;10.00</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>12008</CLAVE><DESCRIPCION>Total de Contribuciones</DESCRIPCION><VALOR>200</VALOR><VALORIMPRESION>&#x24;200.00</VALORIMPRESION></CONCEPTO><CONCEPTO><CLAVE>12020</CLAVE><DESCRIPCION>Cantidad Pagada</DESCRIPCION><VALOR>200</VALOR><VALORIMPRESION>&#x24;200.00</VALORIMPRESION></CONCEPTO></CONCEPTOS></DERECHOS>";
		String cadenaOriginal ="||10001=CACJ811003H35|10017=2684|20001=|20002=|40002=|40003=|40008=|12002=7|12027=2015|12004=160|12005=8|12006=8|12007=8|12008=184|12020=184|12002=7|12027=2015|12004=170|12005=10|12006=10|12007=10|12008=200|12020=200|14702=1|14727=2005|14704=1000|14705=50|14706=50|14707=50|14708=1150|14720=1150|14733=346000601|14734=CERTIF20051053|14702=2|14727=2005|14704=1000|14705=50|14706=50|14707=50|14708=1150|14720=1150|14733=346000601|14734=CERTIF20051043|30003=|30004=||";
		
		//Se genera el pojo
		Derechos derechos = ParseXMLToPojoFactory.transform(xml, Derechos.class);
		//Se inicializa el builder
		cadenaFinal.append(INICIO_FIN_CADENA);
		//Se remueven incio y fin de cadena  
		cadenaOriginal = cadenaOriginal.substring(2, cadenaOriginal.length() - 2);
		//Estos valores vienen en la cadena original o fueron calculados ya en el proceso
		//		10017	Total efectivamente pagado	3200
		//		20001	Codigo de Banco (Fijo)	40062
		//		20002	Folio generado	13000051
		//		40002	Fecha Operación(YYYYMMDD)	20150723
		//		40003	Hora Operación(HH:mm)	09:55
		//		40008	Llave del Pago(String de 10 posiciones)	6932E96C78
		//		30003	Numero de Certificado(Fijo)	1000007000163580
		//		30004	Blanco (No se incluye)	NA
		
		String[] tokens =  cadenaOriginal.split("\\|");
		for (String token : tokens) {
			String[] parValue = token.split("=");
			if(parValue.length ==1 || parValue[1] == null || StringUtils.isEmpty(parValue[1])){
				//Valida si son codigos Default
				if(parValue[0].equals("20001")){ //Codigo de Banco va Fijo
					cadenaFinal.append(token.trim()+ "40062");
				}else if(parValue[0].equals("20002")){//Folio de Pago
					cadenaFinal.append(token.trim()+ "13000051");
				}else if(parValue[0].equals("40002")){//Fecha Operacion
					cadenaFinal.append(token.trim()+ "20150723");
				}else if(parValue[0].equals("40003")){ //Hora del pago
					cadenaFinal.append(token.trim()+ "09:55");
				}else if(parValue[0].equals("40008")){ //Llave del Pago 
					cadenaFinal.append(token.trim()+ "6932E96C78");
				}else if(parValue[0].equals("30003")){ //Certificado
					cadenaFinal.append(token.trim()+ "1000007000163580");
				}else if(parValue[0].equals("30004")){ //Blanco (No se incluye)	NA
					continue;					
				}else{ //Busca Valor en Conceptos
					Concepto concepto = null;
					for(Conceptos conceptos : derechos.getConceptos()){
						concepto = Concepto.getConcepto(conceptos.getConceptos(), parValue[0].trim());
						if(concepto != null){
							break;
						}
					}
					cadenaFinal.append(token.trim()+ concepto != null ? concepto.getValor():"0");					
				}
				
			}else{
				cadenaFinal.append(token);
			}

			cadenaFinal.append(INICIO_FIN_CAMPO);
			
			LOG.info("Cadena Generada ===> " + String.format("%04d", cadenaFinal.length())  + cadenaFinal.toString());
		}
		
		//Remueve ultimo caracter
		String cadenaSello = cadenaFinal.substring(0, cadenaFinal.length() -1);
 		LOG.info("Cadena Generada ===> " + String.format("%04d", cadenaSello.length()) + cadenaSello.toString());
 		LOG.info("Cadena Original ===> " + cadenaOriginal.length() + cadenaOriginal.toString());
		
	}
}
